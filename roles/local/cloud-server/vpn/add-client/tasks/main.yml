---

- name: "Check if credentials for '{{ _rin__client_name }}' already exist"
  become: true
  ansible.builtin.stat:
    path: "{{ _gv__vpn_data_volume_path }}/pki/issued/{{ _rin__client_name }}.crt"
  register: client_crt

- name: "Run OpenVPN client build in Docker for '{{ _rin__client_name }}'"
  become: true
  when: not client_crt.stat.exists
  ansible.builtin.expect:
    command: >
      docker run
      -i
      -v {{ _gv__vpn_data_volume_name }}:/etc/openvpn
      --rm {{ _gv__vpn_image }}
      easyrsa build-client-full
      {{ _rin__client_name }}
      nopass
    responses:
      "Enter pass phrase for /etc/openvpn/pki/private/ca.key": "{{ _gv__vpn_ca_pwd }}"
    timeout: 60
  no_log: false

- name: "Inform that credentials already exist"
  when: client_crt.stat.exists
  ansible.builtin.debug:
    msg: "The credentials for '{{ _rin__client_name }}' already exist"

- name: Ensure CCD file exists with correct content for static IP
  when: _rin__static_ip is defined
  become: true
  ansible.builtin.copy:
    dest: "{{ _gv__vpn_data_volume_path }}/ccd/{{ _rin__client_name }}"
    content: "ifconfig-push {{ _rin__static_ip }} 255.255.255.0"
    owner: root
    group: root
    mode: '0644'
